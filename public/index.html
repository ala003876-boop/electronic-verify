<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ø§Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</title>
  <style>
    body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Tahoma; background:#0b1220; color:#e7eefc;}
    .wrap{max-width:900px;margin:30px auto;padding:20px}
    .card{background:rgba(12,18,34,.7); border:1px solid rgba(255,255,255,.08); border-radius:18px; padding:18px; box-shadow:0 12px 40px rgba(0,0,0,.35)}
    h1{margin:0 0 10px;font-size:28px}
    .top{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .btn{cursor:pointer;border:0;border-radius:12px;padding:12px 14px;font-weight:700}
    .btn-primary{background:#22c55e;color:#04140a}
    .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,.15);color:#e7eefc}
    .muted{opacity:.85;font-size:14px}
    .pill{display:inline-flex;gap:8px;align-items:center;padding:8px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);font-size:13px}
    .q{margin-top:14px;border-radius:16px;border:1px solid rgba(255,255,255,.10);padding:14px;background:rgba(255,255,255,.03)}
    .q h3{margin:0 0 10px;font-size:18px}
    .opt{display:flex;gap:10px;align-items:flex-start;margin:8px 0}
    input[type="radio"]{transform:scale(1.1);margin-top:4px}
    .agree{margin-top:14px;display:flex;gap:10px;align-items:center}
    .bar{margin-top:14px;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .msg{margin-top:14px;padding:12px;border-radius:14px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04)}
    .msg.ok{border-color:rgba(34,197,94,.35);background:rgba(34,197,94,.10)}
    .msg.bad{border-color:rgba(239,68,68,.35);background:rgba(239,68,68,.10)}
    .warn{border-color:rgba(234,179,8,.35);background:rgba(234,179,8,.10)}
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;padding:18px}
    .modal{max-width:520px;width:100%;background:#0f1a2f;border:1px solid rgba(255,255,255,.12);border-radius:16px;padding:16px}
    .modal h2{margin:0 0 10px}
    .modal .actions{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="top">
        <div>
          <h1>ğŸ“‹ Ø§Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</h1>
          <div class="muted">Ø§Ø®ØªØ¨Ø§Ø± Ø³Ø±ÙŠØ¹ â€” Ø³Ù…Ø§Ø­ÙŠØ©: <b id="allowedWrong">2</b> Ø£Ø®Ø·Ø§Ø¡. Ù…Ø­Ø§ÙˆÙ„Ø© ÙƒÙ„ 15 Ø¯Ù‚ÙŠÙ‚Ø© ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø§Ù„Ø±Ø³ÙˆØ¨.</div>
        </div>
        <div class="bar">
          <span class="pill" id="cooldownPill" style="display:none;">â³ <span id="cooldownText"></span></span>
          <button class="btn btn-ghost" id="btnLogout" style="display:none;">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
          <button class="btn btn-primary" id="btnLogin">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø¯ÙŠØ³ÙƒÙˆØ±Ø¯</button>
        </div>
      </div>

      <div id="content" style="margin-top:14px"></div>

      <div class="agree">
        <input type="checkbox" id="agree" />
        <label for="agree">Ø£ÙˆØ§ÙÙ‚ Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø±ÙˆØ· ÙˆØ§Ù„Ù‚ÙˆØ§Ù†ÙŠÙ† (Ø¥Ù„Ø²Ø§Ù…ÙŠ)</label>
      </div>

      <div class="bar">
        <button class="btn btn-primary" id="btnSubmit">Ø¥Ø±Ø³Ø§Ù„</button>
        <button class="btn btn-ghost" id="btnReload">ØªØºÙŠÙŠØ± Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</button>
      </div>

      <div id="messageBox" class="msg" style="display:none"></div>
    </div>
  </div>

  <div class="overlay" id="overlay">
    <div class="modal">
      <h2>ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„</h2>
      <div class="muted">Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø¬Ø§Ø¨Ø§ØªÙƒ Ø§Ù„Ø¢Ù†ØŸ</div>
      <div class="actions">
        <button class="btn btn-ghost" id="btnCancel">Ø¥Ù„ØºØ§Ø¡</button>
        <button class="btn btn-primary" id="btnConfirm">ØªØ£ÙƒÙŠØ¯</button>
      </div>
    </div>
  </div>

<script>
const el = (id)=>document.getElementById(id);
const content = el("content");
const msgBox = el("messageBox");
const overlay = el("overlay");
let state = { loggedIn:false, questions:[], cooldown:0, allowedWrong:2 };
let cooldownTimer = null;

function showMsg(text, type="ok"){
  msgBox.style.display="block";
  msgBox.className = "msg " + (type||"");
  msgBox.textContent = text;
}

function hideMsg(){ msgBox.style.display="none"; }

function fmtLeft(ms){
  const s = Math.ceil(ms/1000);
  const m = Math.floor(s/60);
  const r = s%60;
  return `${m} Ø¯Ù‚ÙŠÙ‚Ø© Ùˆ ${r} Ø«Ø§Ù†ÙŠØ©`;
}

function render(){
  content.innerHTML = "";
  hideMsg();

  el("allowedWrong").textContent = state.allowedWrong;

  el("btnLogin").style.display = state.loggedIn ? "none" : "inline-block";
  el("btnLogout").style.display = state.loggedIn ? "inline-block" : "none";

  // cooldown
  if(state.cooldown > 0){
    el("cooldownPill").style.display = "inline-flex";
    el("cooldownText").textContent = `Ø¨Ø§Ù‚ÙŠ: ${fmtLeft(state.cooldown)}`;
    el("btnSubmit").disabled = true;
    el("btnSubmit").style.opacity = .6;
  }else{
    el("cooldownPill").style.display = "none";
    el("btnSubmit").disabled = false;
    el("btnSubmit").style.opacity = 1;
  }

  if(!state.loggedIn){
    showMsg("Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„ Ø¯ÙŠØ³ÙƒÙˆØ±Ø¯ Ø«Ù… Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±.", "warn");
  }

  state.questions.forEach((q, idx)=>{
    const box = document.createElement("div");
    box.className="q";
    box.innerHTML = `<h3>${idx+1}- ${q.title}</h3>`;
    q.options.forEach(opt=>{
      const row = document.createElement("label");
      row.className="opt";
      row.innerHTML = `
        <input type="radio" name="${q.id}" value="${opt.k}">
        <div>${opt.text}</div>
      `;
      box.appendChild(row);
    });
    content.appendChild(box);
  });
}

async function loadQuestions(){
  const res = await fetch("/api/questions");
  const data = await res.json();
  state = data;

  // Ù…Ø¤Ù‚Øª Ø¹Ø¯ ØªÙ†Ø§Ø²Ù„ÙŠ
  if(cooldownTimer) clearInterval(cooldownTimer);
  cooldownTimer = setInterval(()=>{
    if(state.cooldown > 0){
      state.cooldown -= 1000;
      if(state.cooldown < 0) state.cooldown = 0;
      render();
    }
  }, 1000);

  render();
}

function collectAnswers(){
  const answers = [];
  for(const q of state.questions){
    const picked = document.querySelector(`input[name="${q.id}"]:checked`);
    if(!picked) return { ok:false, message:`Ù„Ø§Ø²Ù… ØªØ¬Ø§ÙˆØ¨ Ø¹Ù„Ù‰: ${q.title}` };
    answers.push({ id:q.id, k:picked.value });
  }
  return { ok:true, answers };
}

el("btnLogin").onclick = ()=>location.href="/auth/login";
el("btnLogout").onclick = ()=>location.href="/auth/logout";
el("btnReload").onclick = ()=>loadQuestions();

el("btnSubmit").onclick = ()=>{
  hideMsg();
  const a = collectAnswers();
  if(!a.ok) return showMsg(a.message, "bad");
  if(!el("agree").checked) return showMsg("Ù„Ø§Ø²Ù… ØªÙˆØ§ÙÙ‚ Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø±ÙˆØ·.", "bad");
  overlay.style.display="flex";
};

el("btnCancel").onclick = ()=> overlay.style.display="none";
el("btnConfirm").onclick = async ()=>{
  overlay.style.display="none";
  const a = collectAnswers();
  if(!a.ok) return showMsg(a.message, "bad");

  const payload = {
    agree: true,
    answers: a.answers
  };

  const res = await fetch("/submit", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(payload),
  });

  let data = null;
  try{ data = await res.json(); }catch{ data = { ok:false, message:"Server error" }; }

  if(!res.ok){
    return showMsg(data.message || "Ø®Ø·Ø£", "bad");
  }

  if(data.passed){
    showMsg(data.message || "ØªÙ… Ø§Ù„ØªÙØ¹ÙŠÙ„", "ok");
  }else{
    showMsg(data.message || "Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªÙØ¹ÙŠÙ„", "bad");
  }

  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø³Ø¦Ù„Ø©/Ø§Ù„ÙƒÙˆÙ„Ø¯Ø§ÙˆÙ† Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
  await loadQuestions();
};

loadQuestions();
</script>
</body>
</html>
