<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ø§Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ T15 </title>
  <style>
    body{margin:0;font-family:system-ui;background:#0b1220;color:#e8eefc}
    .wrap{max-width:900px;margin:30px auto;padding:16px}
    .card{background:#0f1a2e;border:1px solid #22355e;border-radius:14px;padding:16px;margin-bottom:12px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    .btn{cursor:pointer;border:0;border-radius:12px;padding:12px 16px;font-weight:700;text-decoration:none;display:inline-flex;align-items:center;justify-content:center}
    .btn.primary{background:#22c55e;color:#06130b}
    .btn.gray{background:#334155;color:#fff}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .qtitle{font-weight:800;margin:0 0 10px 0}
    .opt{display:flex;gap:10px;align-items:center;margin:8px 0}
    .banner{padding:10px 12px;border-radius:12px;margin:10px 0;white-space:pre-line}
    .err{background:#3b0d0d;border:1px solid #7f1d1d}
    .ok{background:#05250f;border:1px solid #14532d}
    .muted{opacity:.75}
    .hr{height:1px;background:#22355e;margin:14px 0}
    a{color:#93c5fd}

    /* ===== Success Modal ===== */
    #successModal{
      display:none; position:fixed; inset:0;
      background:rgba(0,0,0,.55); z-index:9999;
      padding:16px;
    }
    #successModal .box{
      max-width:560px; margin:12vh auto;
      background:#0b1220; border:1px solid rgba(255,255,255,.12);
      border-radius:16px; padding:18px;
      box-shadow:0 10px 35px rgba(0,0,0,.5);
    }
    #successModal .top{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      margin-bottom:10px;
    }
    #successModal h2{margin:0; color:#22c55e; font-size:22px;}
    #successModal p{margin:10px 0 0; color:#e5e7eb; line-height:1.9; white-space:pre-line;}
    #successModal .actions{margin-top:16px; display:flex; justify-content:flex-end; gap:10px; flex-wrap:wrap;}
    #successModal .closeBtn{
      background:transparent; border:none; color:#fff; font-size:22px; cursor:pointer;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="row">
        <div>
          <div style="font-size:22px;font-weight:900">Ø§Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ T15 ğŸ“„</div>
          <div class="muted">Ø§Ø®ØªØ± Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø© Ø«Ù… Ø§Ø¶ØºØ· Ø¥Ø±Ø³Ø§Ù„.</div>
        </div>
        <div id="authBox"></div>
      </div>

      <div id="cooldownBox" class="banner err" style="display:none"></div>
      <div id="msgBox" class="banner" style="display:none"></div>
    </div>

    <div id="questions"></div>

    <!-- âœ… Ø£Ø¹Ø·ÙŠÙ†Ø§ Ù‡Ø°Ø§ Ø§Ù„ÙƒØ±Øª ID Ø¹Ø´Ø§Ù† Ù†Ø®ÙÙŠÙ‡ Ø¨Ø¹Ø¯ Ø§Ù„Ù†Ø¬Ø§Ø­ -->
    <div class="card" id="submitCard">
      <div style="font-weight:900;margin-bottom:10px">Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø±ÙˆØ·</div>
      <label class="opt">
        <input type="checkbox" id="agree" />
        <span>Ù…ÙˆØ§ÙÙ‚ Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø±ÙˆØ·</span>
      </label>
      <div class="hr"></div>
      <button class="btn primary" id="submitBtn" disabled>Ø¥Ø±Ø³Ø§Ù„</button>
      <div class="muted" style="margin-top:8px">
        Ù…Ù„Ø§Ø­Ø¸Ø©: Ù…Ø­Ø§ÙˆÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø±Ø³ÙˆØ¨ ÙÙ‚Ø· ÙƒÙ„ 15 Ø¯Ù‚ÙŠÙ‚Ø©. Ø§Ù„Ø³Ù…Ø§Ø­ÙŠØ©: <span id="allowedWrong">2</span> Ø£Ø®Ø·Ø§Ø¡.
      </div>
    </div>
  </div>

  <!-- âœ… Success Modal -->
  <div id="successModal">
    <div class="box">
      <div class="top">
        <h2>âœ… Ù…Ø¨Ø±ÙˆÙƒ</h2>
        <button class="closeBtn" id="closeSuccess" type="button">âœ–</button>
      </div>
      <p id="successText">ØªÙ… Ø§Ù„ØªÙØ¹ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­ ğŸ‰</p>

      <div class="actions">
        <a class="btn primary" id="goDiscordBtn" href="#" target="_blank" rel="noopener">Ø§Ø°Ù‡Ø¨ Ù„Ù„Ø¯Ø³ÙƒÙˆØ±Ø¯</a>
        <button class="btn gray" id="refreshBtn" type="button">ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©</button>
      </div>
    </div>
  </div>

<script>
/* Ø¶Ø¹ Ø±Ø§Ø¨Ø· Ø¯Ø¹ÙˆØ© Ø³ÙŠØ±ÙØ±Ùƒ Ù‡Ù†Ø§ */
const DISCORD_INVITE_URL = "https://discord.gg/5ByfhYY9S6";


let state = { loggedIn:false, questions:[], cooldown:0, allowedWrong:2 };
let chosen = new Map(); // qid -> optionKey

function showMsg(text, ok=false){
  const box = document.getElementById("msgBox");
  box.style.display = "block";
  box.className = "banner " + (ok ? "ok" : "err");
  box.textContent = text;
}

function hideMsg(){
  const box = document.getElementById("msgBox");
  box.style.display = "none";
}

function setCooldown(ms){
  const box = document.getElementById("cooldownBox");
  if(!ms || ms<=0){ box.style.display="none"; return; }
  box.style.display="block";
  const end = Date.now() + ms;
  const t = setInterval(()=>{
    const left = Math.max(0, end - Date.now());
    const m = Math.floor(left/60000);
    const s = Math.floor((left%60000)/1000);
    box.textContent = `â³ Ù„Ø¯ÙŠÙƒ Ù…Ø­Ø§ÙˆÙ„Ø© ÙˆØ§Ø­Ø¯Ø© ÙƒÙ„ 15 Ø¯Ù‚ÙŠÙ‚Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø±Ø³ÙˆØ¨. Ø§Ù„Ø¨Ø§Ù‚ÙŠ: ${m} Ø¯Ù‚ÙŠÙ‚Ø© Ùˆ ${s} Ø«Ø§Ù†ÙŠØ©`;
    if(left<=0){ clearInterval(t); box.style.display="none"; }
  }, 250);
}

function updateSubmitEnabled(){
  const agree = document.getElementById("agree").checked;
  const allAnswered = state.questions.length>0 && chosen.size === state.questions.length;
  const btn = document.getElementById("submitBtn");
  btn.disabled = !(agree && allAnswered && (!state.cooldown || state.cooldown<=0));
}

function renderAuth(){
  const box = document.getElementById("authBox");
  if(state.loggedIn){
    box.innerHTML = `<button class="btn gray" onclick="location.href='/auth/logout'">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>`;
  }else{
    box.innerHTML = `<button class="btn gray" onclick="location.href='/auth/login'">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø¯ÙŠØ³ÙƒÙˆØ±Ø¯</button>`;
  }
}

function renderQuestions(){
  const root = document.getElementById("questions");
  root.innerHTML = "";
  chosen.clear();

  state.questions.forEach((q, idx)=>{
    const card = document.createElement("div");
    card.className="card";
    card.innerHTML = `
      <div class="qtitle">${idx+1}- ${q.title}</div>
      <div id="opts-${q.id}"></div>
    `;
    const opts = card.querySelector(`#opts-${q.id}`);
    q.options.forEach((o)=>{
      const id = `${q.id}-${o.k}`;
      const row = document.createElement("label");
      row.className="opt";
      row.innerHTML = `
        <input type="radio" name="${q.id}" id="${id}" value="${o.k}">
        <span>${o.text}</span>
      `;
      row.querySelector("input").addEventListener("change",(e)=>{
        chosen.set(q.id, e.target.value);
        updateSubmitEnabled();
      });
      opts.appendChild(row);
    });
    root.appendChild(card);
  });

  updateSubmitEnabled();
}

/* ===== Success Modal helpers ===== */
function openSuccessModal(message){
  const modal = document.getElementById("successModal");
  const text = document.getElementById("successText");
  if(text) text.textContent = message || "Ù…Ø¨Ø±ÙˆÙƒ ØªÙ… Ø§Ù„ØªÙØ¹ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­ âœ…";
  if(modal) modal.style.display = "block";
}
function closeSuccessModal(){
  const modal = document.getElementById("successModal");
  if(modal) modal.style.display = "none";
}

/* Ø§Ø®ÙØ§Ø¡ ÙƒÙ„ Ø´ÙŠØ¡ Ø¨Ø¹Ø¯ Ø§Ù„Ù†Ø¬Ø§Ø­ + ØªÙØ¹ÙŠÙ„ Ø²Ø± Ø§Ù„Ø¯Ø³ÙƒÙˆØ±Ø¯ */
function hideAfterPass(){
  const q = document.getElementById("questions");
  if(q) q.style.display = "none";

  const submitCard = document.getElementById("submitCard");
  if(submitCard) submitCard.style.display = "none";

  const cd = document.getElementById("cooldownBox");
  if(cd) cd.style.display = "none";

  const msg = document.getElementById("msgBox");
  if(msg) msg.style.display = "none";

  const go = document.getElementById("goDiscordBtn");
  if(go) go.href = DISCORD_INVITE_URL;
}

document.getElementById("closeSuccess").addEventListener("click", closeSuccessModal);
document.getElementById("refreshBtn").addEventListener("click", ()=> location.reload());
document.getElementById("successModal").addEventListener("click", (e)=>{
  if(e.target && e.target.id === "successModal") closeSuccessModal();
});

async function load(){
  hideMsg();
  const res = await fetch("/api/questions");
  const data = await res.json();
  state = data;
  document.getElementById("allowedWrong").textContent = data.allowedWrong ?? 2;
  renderAuth();
  setCooldown(data.cooldown || 0);
  renderQuestions();
  updateSubmitEnabled();
}

document.getElementById("agree").addEventListener("change", updateSubmitEnabled);

document.getElementById("submitBtn").addEventListener("click", async ()=>{
  hideMsg();

  if(!state.loggedIn){
    showMsg("Ù„Ø§Ø²Ù… ØªØ³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Ø¯ÙŠØ³ÙƒÙˆØ±Ø¯ Ø£ÙˆÙ„.");
    return;
  }

  if(chosen.size !== state.questions.length){
    showMsg("Ù„Ø§Ø²Ù… ØªØ¬Ø§ÙˆØ¨ Ø¹Ù„Ù‰ ÙƒÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„.");
    return;
  }

  const payload = {
    agree: true,
    answers: state.questions.map(q => ({ id:q.id, k: chosen.get(q.id) }))
  };

  const res = await fetch("/submit", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(payload)
  });

  const out = await res.json().catch(()=>({ok:false,message:"Server error"}));

  if(!res.ok){
    showMsg(out.message || "Server error");
    return;
  }

  // âœ… Ø¥Ø°Ø§ Ù†Ø¬Ø­: Ø§Ø®ÙÙŠ ÙƒÙ„ Ø´ÙŠØ¡ ÙˆØ·Ù„Ø¹ Ø®Ø§Ù†Ø© Ù…Ø¨Ø±ÙˆÙƒ + Ø²Ø± Ø§Ù„Ø¯Ø³ÙƒÙˆØ±Ø¯
  if(out && out.passed === true){
    hideAfterPass();
    openSuccessModal("ğŸ‰ Ù…Ø¨Ø±ÙˆÙƒ ØªÙ… Ø§Ù„ØªÙØ¹ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­ âœ…\nØ§Ø¶ØºØ· (Ø§Ø°Ù‡Ø¨ Ù„Ù„Ø¯Ø³ÙƒÙˆØ±Ø¯).");
    return;
  }

  // âŒ Ø¥Ø°Ø§ Ø±Ø³Ø¨: ØªØ¸Ù‡Ø± Ø±Ø³Ø§Ù„Ø© + Ù†Ø¹ÙŠØ¯ ØªØ­Ù…ÙŠÙ„ Ø¹Ø´Ø§Ù† ÙŠØ¸Ù‡Ø± Ø§Ù„ÙƒÙˆÙ„Ø¯Ø§ÙˆÙ† ÙˆØ§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
  showMsg(out.message || "ØªÙ…", false);
  await load();
});

load();
</script>
</body>
</html>
