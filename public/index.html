<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ø§Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</title>
  <style>
    body{background:#0f172a;color:#e5e7eb;font-family:Tahoma;direction:rtl;padding:22px}
    .box{max-width:980px;margin:auto;background:#020617;border-radius:14px;padding:22px;box-shadow:0 0 30px rgba(0,0,0,.45)}
    h1{margin:0 0 14px;text-align:center;color:#38bdf8}
    .topbar{display:flex;gap:10px;justify-content:space-between;align-items:center;flex-wrap:wrap;margin-bottom:12px}
    .btn{padding:10px 14px;border-radius:10px;border:0;cursor:pointer;font-weight:bold}
    .btnLogin{background:#5865F2;color:#fff}
    .btnLogout{background:#334155;color:#fff}
    .btnSubmit{width:100%;background:#22c55e;color:#07110b;font-size:16px;padding:14px}
    .btnSubmit:disabled{opacity:.6;cursor:not-allowed}
    .card{background:#0b1223;border:1px solid #1f2a44;border-radius:12px;padding:14px;margin:12px 0}
    .qtitle{font-weight:bold;margin-bottom:10px}
    .opt{display:flex;gap:10px;align-items:flex-start;margin:8px 0}
    .muted{color:#9ca3af;font-size:13px}
    .msg{margin-top:12px;padding:12px;border-radius:12px;display:none}
    .ok{background:#052e16;border:1px solid #14532d}
    .bad{background:#2a0b0b;border:1px solid #7f1d1d}
    .warn{background:#1d1f05;border:1px solid #5a4f14}
    .line{height:1px;background:#1f2a44;margin:12px 0}
  </style>
</head>
<body>
  <div class="box">
    <h1>ğŸ“‹ Ø§Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</h1>

    <div class="topbar">
      <div id="status" class="muted">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦</div>
      <div>
        <button id="loginBtn" class="btn btnLogin" style="display:none">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø¯ÙŠØ³ÙƒÙˆØ±Ø¯</button>
        <button id="logoutBtn" class="btn btnLogout" style="display:none">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
      </div>
    </div>

    <div id="cooldownBox" class="msg warn"></div>

    <form id="form">
      <div id="questions"></div>

      <div class="card">
        <div class="qtitle">âœ… Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø±ÙˆØ·</div>
        <label class="opt">
          <input type="radio" name="agree" value="true" required />
          <span>Ù…ÙˆØ§ÙÙ‚ Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø±ÙˆØ·</span>
        </label>
        <label class="opt">
          <input type="radio" name="agree" value="false" />
          <span>ØºÙŠØ± Ù…ÙˆØ§ÙÙ‚</span>
        </label>
        <div class="muted">Ù„Ø§Ø²Ù… ØªÙˆØ§ÙÙ‚ Ø¹Ø´Ø§Ù† ÙŠØªÙ… Ø§Ù„ØªÙØ¹ÙŠÙ„.</div>
      </div>

      <button id="submitBtn" class="btn btnSubmit" type="submit">Ø¥Ø±Ø³Ø§Ù„</button>
    </form>

    <div id="result" class="msg"></div>
    <div class="line"></div>
    <div class="muted">Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ÙˆØ§Ù„Ø®ÙŠØ§Ø±Ø§Øª ØªØªØºÙŠØ± ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ ÙƒÙ„ Ù…Ø±Ø©.</div>
  </div>

<script>
  const statusEl = document.getElementById("status");
  const loginBtn = document.getElementById("loginBtn");
  const logoutBtn = document.getElementById("logoutBtn");
  const qWrap = document.getElementById("questions");
  const resultEl = document.getElementById("result");
  const cooldownBox = document.getElementById("cooldownBox");
  const submitBtn = document.getElementById("submitBtn");

  function fmt(sec){
    sec = Math.max(0, sec|0);
    const m = Math.floor(sec/60);
    const s = sec%60;
    return `${m} Ø¯Ù‚ÙŠÙ‚Ø© Ùˆ ${s} Ø«Ø§Ù†ÙŠØ©`;
  }

  async function loadQuestions(){
    resultEl.style.display = "none";
    cooldownBox.style.display = "none";
    qWrap.innerHTML = "";
    statusEl.textContent = "Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦";

    const r = await fetch("/api/questions");
    const data = await r.json();

    if (!data.loggedIn){
      statusEl.textContent = "Ù„Ø§Ø²Ù… ØªØ³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Ø¯ÙŠØ³ÙƒÙˆØ±Ø¯ Ù‚Ø¨Ù„ Ø§Ù„ØªÙØ¹ÙŠÙ„.";
      loginBtn.style.display = "inline-block";
      logoutBtn.style.display = "none";
      submitBtn.disabled = true;
      loginBtn.onclick = () => location.href = "/auth/login";
      return;
    }

    loginBtn.style.display = "none";
    logoutBtn.style.display = "inline-block";
    logoutBtn.onclick = () => location.href = "/auth/logout";
    submitBtn.disabled = false;

    // Ø¹Ø±Ø¶ Ø§Ù„ØªØ¨Ø±ÙŠØ¯
    if (data.cooldown && data.cooldown > 0){
      cooldownBox.className = "msg warn";
      cooldownBox.style.display = "block";
      cooldownBox.textContent = `â³ Ù„Ø¯ÙŠÙƒ Ù…Ø­Ø§ÙˆÙ„Ø© ÙˆØ§Ø­Ø¯Ø© ÙƒÙ„ 15 Ø¯Ù‚ÙŠÙ‚Ø©. Ø¨Ø§Ù‚ÙŠ: ${fmt(Math.ceil(data.cooldown/1000))}`;
    }

    statusEl.textContent = "Ø§Ø®ØªØ± Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© Ù„ÙƒÙ„ Ø³Ø¤Ø§Ù„.";

    // Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©
    data.questions.forEach((q, idx) => {
      const card = document.createElement("div");
      card.className = "card";
      card.dataset.qid = q.id;

      const title = document.createElement("div");
      title.className = "qtitle";
      title.textContent = `${idx+1}- ${q.title}`;
      card.appendChild(title);

      q.options.forEach(opt => {
        const label = document.createElement("label");
        label.className = "opt";
        label.innerHTML = `
          <input type="radio" name="${q.id}" value="${opt.k}" required>
          <span>${opt.text}</span>
        `;
        card.appendChild(label);
      });

      qWrap.appendChild(card);
    });
  }

  document.getElementById("form").addEventListener("submit", async (e) => {
    e.preventDefault();
    resultEl.style.display = "none";

    // Ø¬Ù…Ø¹ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª
    const answers = [];
    document.querySelectorAll(".card[data-qid]").forEach(card => {
      const qid = card.dataset.qid;
      const chosen = card.querySelector(`input[name="${qid}"]:checked`);
      if (chosen){
        answers.push({ id: qid, k: chosen.value });
      }
    });

    const agree = document.querySelector('input[name="agree"]:checked')?.value || "false";

    submitBtn.disabled = true;
    submitBtn.textContent = "Ø¬Ø§Ø±Ù Ø§Ù„Ø¥Ø±Ø³Ø§Ù„â€¦";

    try{
      const res = await fetch("/submit", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ answers, agree })
      });
      const out = await res.json();

      resultEl.style.display = "block";
      if (!out.ok){
        resultEl.className = "msg bad";
        resultEl.textContent = out.message || "Server error";
      } else {
        resultEl.className = out.passed ? "msg ok" : "msg bad";
        resultEl.textContent = out.message || (out.passed ? "ØªÙ…" : "Ù„Ù… ÙŠØªÙ…");
      }

      // Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: Ø£Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ù„ÙŠØµÙŠØ± ØªÙ„Ø®Ø¨Ø· Ø¬Ø¯ÙŠØ¯ + ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ¨Ø±ÙŠØ¯
      await loadQuestions();
    }catch(err){
      resultEl.style.display = "block";
      resultEl.className = "msg bad";
      resultEl.textContent = "Server error";
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = "Ø¥Ø±Ø³Ø§Ù„";
    }
  });

  loadQuestions();
</script>
</body>
</html>
